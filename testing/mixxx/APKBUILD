# Contributor: Alexander Edland <alpine@ocv.me>
# Maintainer: Alexander Edland <alpine@ocv.me>
# TODO: test on grsec
# TODO: ensure all dependencies
pkgname=mixxx
pkgver=2.2.0
pkgrel=0
pkgdesc="DJ / livemixing / radio broadcasting studio"
url="https://www.mixxx.org/"
arch="all"
license="GPL-2.0-or-later"
depends="icu-libs qt5-qtbase-sqlite"
depends_dev=""
makedepends="scons qt5-qtbase-dev upower-dev libshout-dev libusb-dev
	libmad-dev
	libid3tag-dev chromaprint-dev protobuf-dev glu-dev taglib-dev
	rubberband-dev portaudio-dev portmidi-dev vamp-sdk-dev
	ffmpeg-dev libsndfile-dev flac-dev icu-libs xvfb qt5-qtbase-sqlite
	lilv-dev opusfile-dev qt5-qtx11extras-dev qt5-qttools-dev qt5-qtscript-dev qt5-qtsvg-dev"
install="$pkgname.post-install"
subpackages="$pkgname-doc"
source="https://github.com/mixxxdj/mixxx/archive/release-$pkgver.tar.gz
	no-rtsched.patch
	bind-duck-to-mic-switch.patch"
builddir="$srcdir/mixxx-release-$pkgver"
_scons_args="
	optimize=portable
	build=release
	prefix=/usr
	qtdir=/usr
	test=1
	mad=1
	ffmpeg=1
	localecompare=1
	virtualize=0
	qt5=1
	-j $JOBS"

build() {
	# START DEBUG
	if [ -e "$startdir/src.arc" ]; then
		rm -rf "$srcdir"
		mkdir -p "$srcdir"
		cd "$startdir"
		tar -zxf "$startdir/src.arc"
	fi
	#END DEBUG

	cd "$startdir"/hacks
	find -type f | while IFS= read -r x; do
		cat "$x" > "$builddir/$x"
	done
	
	cd "$builddir"
	scons \
		$_scons_args \
		install_root="$pkgdir/usr"
	
	# START DEBUG
	if [ ! -e "$startdir/src.arc" ]; then
		rm "$startdir/src.arc" || true
		tar --xattrs -czf "$startdir/src.arc" -C "$startdir" src
	fi
	# END DEBUG
}

check() {
	cd "$builddir"
	/bin/sh "$startdir"/x.sh \
		./mixxx-test
}

package() {
	cd "$builddir"
	scons \
		$_scons_args \
		install_root="$pkgdir/usr" \
		install
	
	# the test binary is useless without the in-tree test data
	rm "$pkgdir/usr/bin/mixxx-test"
	
	# snd-seq provides /dev/snd/seq for midi controllers
	mkdir -p "$pkgdir/etc/modules-load.d"
	echo snd-seq > "$pkgdir/etc/modules-load.d/mixxx.conf"
}

sha512sums="8174b504d236cde36c636985e0e224915f0be69b13691bf0d88c21087c20c1100ff55561b6e395d97fe5b21a0229fe9ecdac2493cb44fa99a42549c368fa2134  release-2.2.0.tar.gz
2092c137977f75d1a37c71ed1f2f9dc0ae58ba9437324a535a458009f538b7fc1882701a25ac2af9654a607de5a724bf77e270e85b3157f158be8dc16f5bd195  no-rtsched.patch
05cd55cb3159a1caf6052004a34510853969a7f222fee70064357fe4e6c76864296ead484beed462d3b804637f147dbafc32a97ce3daa1f753da60ffe21cd52d  bind-duck-to-mic-switch.patch"
