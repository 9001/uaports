# Contributor: Alexander Edland <alpine@ocv.me>
# Maintainer: Alexander Edland <alpine@ocv.me>
# TODO: test on grsec
# TODO: ensure all dependencies
pkgname=mixxx
pkgver=2.2.2
pkgrel=0
pkgdesc="DJ / livemixing / radio broadcasting studio"
url="https://www.mixxx.org/"
arch="all"
license="GPL-2.0-or-later"
depends="icu-libs qt5-qtbase-sqlite"
depends_dev=""
makedepends="
	scons qt5-qtbase-dev qt5-qtbase-dev qt5-qtbase-sqlite
	qt5-qtscript-dev qt5-qtsvg-dev qt5-qttools-dev qt5-qtx11extras-dev
	upower-dev libusb-dev lilv-dev
	chromaprint-dev protobuf-dev glu-dev taglib-dev
	libshout-dev libid3tag-dev portaudio-dev portmidi-dev vamp-sdk-dev
	ffmpeg-dev libmad-dev libsndfile-dev opusfile-dev opus-dev flac-dev
	rubberband-dev icu-libs xvfb"
install="$pkgname.post-install"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/mixxxdj/mixxx/archive/release-$pkgver.tar.gz
	no-rtsched.patch
	support-opus.patch
	bind-duck-to-mic-switch.patch"
builddir="$srcdir/mixxx-release-$pkgver"
_scons_args="
	optimize=portable
	build=release
	prefix=/usr
	qtdir=/usr
	test=1
	mad=1
	opus=1
	ffmpeg=1
	localecompare=1
	qt_sqlite_plugin=0
	virtualize=0
	qt5=1
	-j $JOBS"

build() {
	# START DEBUG
	if [ -e "$startdir/src.arc" ]; then
		rm -rf "$srcdir"
		mkdir -p "$srcdir"
		cd "$startdir"
		tar -zxf "$startdir/src.arc"
	fi
	#END DEBUG

	cd "$builddir"
	scons \
		$_scons_args \
		install_root="$pkgdir/usr"
	
	# START DEBUG
	if [ ! -e "$startdir/src.arc" ]; then
		rm "$startdir/src.arc" || true
		tar --xattrs -czf "$startdir/src.arc" -C "$startdir" src
	fi
	# END DEBUG
}

check() {
	return 0
	cd "$builddir"
	/bin/sh "$startdir"/x.sh \
		./mixxx-test
}

package() {
	cd "$builddir"
	scons \
		$_scons_args \
		install_root="$pkgdir/usr" \
		install
	
	# the test binary is useless without the in-tree test data
	rm "$pkgdir/usr/bin/mixxx-test"
	
	# snd-seq provides /dev/snd/seq for midi controllers
	mkdir -p "$pkgdir/etc/modules-load.d"
	echo snd-seq > "$pkgdir/etc/modules-load.d/mixxx.conf"
}

sha512sums="3b9365bd9d9a7d387cd8791d7d9f6315116e04322370db103998d5e055a6de5e159a4605c7de96cbcf13e7d0653cbe53140dca18a8c3f1b688b227be2c4aeb6f  mixxx-2.2.2.tar.gz
2092c137977f75d1a37c71ed1f2f9dc0ae58ba9437324a535a458009f538b7fc1882701a25ac2af9654a607de5a724bf77e270e85b3157f158be8dc16f5bd195  no-rtsched.patch
53bbd6981e8f415930f010e02c4e3a84c907d1bc3ae3ba9ec6eec0c65aa6890edee0eaa69d9b18119432523b93ef545a9c5ceb2d3c1887aad144882f753a9f45  support-opus.patch
05cd55cb3159a1caf6052004a34510853969a7f222fee70064357fe4e6c76864296ead484beed462d3b804637f147dbafc32a97ce3daa1f753da60ffe21cd52d  bind-duck-to-mic-switch.patch"
